<!-- src/app/pages/admin/usuarios/gestion-usuarios.component.html -->

<div [ngClass]="config.containerClass">
  <div class="header">
    <h1><i [class]="'bi ' + config.icono"></i> Gesti√≥n de {{ config.nombrePlural }}</h1>
    <div class="header-actions">
      @if (!verInactivos) {
        <button
          class="btn btn-icon-only btn-trash"
          (click)="toggleVerInactivos()"
          [title]="'Ver ' + config.nombrePlural.toLowerCase() + ' inactivos'">
          <i class="bi bi-trash"></i>
        </button>
      }

      @if (verInactivos) {
        <button
          class="btn btn-secondary"
          (click)="toggleVerInactivos()">
          <i class="bi bi-arrow-left-circle"></i> Volver a Activos
        </button>
      }

      <button class="btn btn-primary" (click)="abrirModalCrear()">
        <i class="bi bi-plus-circle"></i> Nuevo {{ config.nombreSingular }}
      </button>
    </div>
  </div>

  <div class="filtros">
    <div class="filtro-busqueda">
      <div class="input-busqueda-wrapper">
        <i class="bi bi-search"></i>
        <input
          type="text"
          [(ngModel)]="filtros.busqueda"
          (input)="buscar()"
          placeholder="Buscar por nombre, email o tel√©fono..."
          class="input-busqueda"
        />
      </div>
    </div>

    @if (tieneFiltrosActivos()) {
      <div class="filtros-activos">
        <button class="limpiar-filtros" (click)="limpiarTodosFiltros()">
          <i class="bi bi-x-circle"></i>
          Limpiar filtros
        </button>
      </div>
    }
  </div>

  @if (loading) {
    <div class="loading">
      <div class="spinner"></div>
      <p>Cargando {{ config.nombrePlural.toLowerCase() }}...</p>
    </div>
  }

  @if (!loading) {
    <div class="tabla-container">
      <div class="tabla-header">
        <h3>
          <i [class]="verInactivos ? 'bi bi-trash-fill' : 'bi ' + config.icono"></i>
          {{ config.nombrePlural }} {{ verInactivos ? 'Inactivos' : 'Activos' }}
        </h3>
        <span class="badge" [ngClass]="verInactivos ? 'badge-danger' : 'badge-success'">
          {{ totalRegistros }} {{ totalRegistros === 1 ? config.nombreSingular.toLowerCase() : config.nombrePlural.toLowerCase() }}
        </span>
      </div>
      <table class="tabla">
        <thead>
          <tr>
            <th>Foto</th>
            <th>Nombres</th>
            <th>Apellidos</th>
            <th>Email</th>
            <th>Tel√©fono</th>
            <th>Estado</th>
            <th>Fecha Registro</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          @for (usuario of usuarios; track usuario.id_usuario) {
            <tr>
              <td>
                <div class="usuario-avatar-small">
                  @if (tieneFoto(usuario)) {
                    <img 
                      [src]="getFotoUsuario(usuario)" 
                      [alt]="usuario.nombres"
                      class="avatar-img"
                      onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                    />
                    <i class="bi bi-person-circle avatar-placeholder" style="display: none;"></i>
                  } @else {
                    <i class="bi bi-person-circle avatar-placeholder"></i>
                  }
                </div>
              </td>
              <td>{{ usuario.nombres }}</td>
              <td>{{ usuario.apellidos }}</td>
              <td>
                <i class="bi bi-envelope"></i> {{ usuario.email }}
              </td>
              <td>
                <i class="bi bi-telephone"></i> {{ usuario.telefono || '-' }}
              </td>
              <td>
                <span class="badge" [ngClass]="getEstadoBadgeClass(usuario.estado)">
                  {{ usuario.estado }}
                </span>
              </td>
              <td>{{ usuario.fecha_registro | date: 'dd/MM/yyyy' }}</td>
              <td class="acciones">
                <button
                  (click)="abrirModalDetalles(usuario)"
                  class="btn-icon btn-view"
                  title="Ver detalles">
                  <i class="bi bi-eye"></i>
                </button>
                <button
                  (click)="abrirModalEditar(usuario)"
                  class="btn-icon btn-edit"
                  title="Editar">
                  <i class="bi bi-pencil-square"></i>
                </button>
                @if (usuario.estado === 'Activo') {
                  <button
                    (click)="cambiarEstado(usuario, 'Inactivo')"
                    class="btn-icon btn-disable"
                    title="Desactivar">
                    <i class="bi bi-x-circle"></i>
                  </button>
                }
                @if (usuario.estado === 'Inactivo' || usuario.estado === 'Suspendido') {
                  <button
                    (click)="cambiarEstado(usuario, 'Activo')"
                    class="btn-icon btn-enable"
                    title="Activar">
                    <i class="bi bi-check-circle"></i>
                  </button>
                }
              </td>
            </tr>
          }
        </tbody>
      </table>
      @if (usuarios.length === 0) {
        <div class="sin-resultados">
          <i [class]="verInactivos ? 'bi bi-trash' : 'bi bi-inbox'"></i>
          <p>No se encontraron {{ config.nombrePlural.toLowerCase() }} {{ verInactivos ? 'inactivos' : 'activos' }}</p>
        </div>
      }
    </div>
  }

  @if (!loading && totalPaginas > 0) {
    <div class="paginacion">
      <div class="paginacion-info">
        <span class="info-text">
          <i class="bi bi-file-earmark-text"></i>
          Mostrando {{ (paginaActual - 1) * (filtros.registros_por_pagina || 10) + 1 }}
          a {{ Math.min(paginaActual * (filtros.registros_por_pagina || 10), totalRegistros) }}
          de {{ totalRegistros }} registros
        </span>
      </div>
      <div class="paginacion-controles">
        <button
          (click)="cambiarPagina(paginaActual - 1)"
          [disabled]="paginaActual === 1"
          class="btn btn-paginacion">
          <i class="bi bi-chevron-left"></i> Anterior
        </button>
        <span class="pagina-actual">
          P√°gina {{ paginaActual }} de {{ totalPaginas }}
        </span>
        <button
          (click)="cambiarPagina(paginaActual + 1)"
          [disabled]="paginaActual === totalPaginas"
          class="btn btn-paginacion">
          Siguiente <i class="bi bi-chevron-right"></i>
        </button>
      </div>
      <select
        [(ngModel)]="filtros.registros_por_pagina"
        (change)="cambiarRegistrosPorPagina()"
        class="select-paginacion">
        @for (opcion of opcionesPorPagina; track opcion) {
          <option [value]="opcion">
            {{ opcion }} por p√°gina
          </option>
        }
      </select>
    </div>
  }

  <!-- MODAL DETALLES -->
  @if (mostrarModalDetalles && usuarioDetalles) {
    <div class="modal-overlay" (click)="cerrarModalDetalles()">
      <div class="modal modal-detalles" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>
            <i class="bi bi-person-vcard-fill"></i>
            Detalles del {{ config.nombreSingular }}
          </h2>
          <button (click)="cerrarModalDetalles()" class="btn-close">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        <div class="modal-body modal-body-detalles">
          <div class="usuario-card">
            <div class="usuario-avatar">
              @if (tieneFoto(usuarioDetalles)) {
                <img 
                  [src]="getFotoUsuario(usuarioDetalles)" 
                  [alt]="usuarioDetalles.nombres"
                  class="avatar-img-large"
                  onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                />
                <i class="bi bi-person-circle" style="display: none;"></i>
              } @else {
                <i class="bi bi-person-circle"></i>
              }
            </div>
            <div class="usuario-info-principal">
              <h3>{{ usuarioDetalles.nombres }} {{ usuarioDetalles.apellidos }}</h3>
              <span class="badge" [ngClass]="getBadgeRolClass()">{{ config.emoji }} {{ config.nombreSingular }}</span>
              <span class="badge" [ngClass]="getEstadoBadgeClass(usuarioDetalles.estado)" style="margin-left: 8px;">
                {{ usuarioDetalles.estado }}
              </span>
            </div>
          </div>
          <div class="seccion-detalles">
            <h4><i class="bi bi-person-fill"></i> Informaci√≥n Personal</h4>
            <div class="detalles-grid">
              <div class="detalle-item">
                <label><i class="bi bi-person"></i> Nombres</label>
                <span>{{ usuarioDetalles.nombres }}</span>
              </div>
              <div class="detalle-item">
                <label><i class="bi bi-person"></i> Apellidos</label>
                <span>{{ usuarioDetalles.apellidos }}</span>
              </div>
              <div class="detalle-item">
                <label><i class="bi bi-gender-ambiguous"></i> G√©nero</label>
                <span>{{ usuarioDetalles.genero || 'No especificado' }}</span>
              </div>
              <div class="detalle-item">
                <label><i class="bi bi-calendar"></i> Fecha de Nacimiento</label>
                <span>{{ usuarioDetalles.fecha_nacimiento ? (usuarioDetalles.fecha_nacimiento | date: 'dd/MM/yyyy') : 'No registrada' }}</span>
              </div>
            </div>
          </div>
          <div class="seccion-detalles">
            <h4><i class="bi bi-envelope-fill"></i> Informaci√≥n de Contacto</h4>
            <div class="detalles-grid">
              <div class="detalle-item">
                <label><i class="bi bi-envelope"></i> Email</label>
                <span>{{ usuarioDetalles.email }}</span>
              </div>
              <div class="detalle-item">
                <label><i class="bi bi-telephone"></i> Tel√©fono</label>
                <span>{{ usuarioDetalles.telefono || 'No registrado' }}</span>
              </div>
              <div class="detalle-item detalle-item-full">
                <label><i class="bi bi-geo-alt"></i> Direcci√≥n</label>
                <span>{{ usuarioDetalles.direccion || 'No registrada' }}</span>
              </div>
            </div>
          </div>
          <div class="seccion-detalles">
            <h4><i class="bi bi-gear-fill"></i> Informaci√≥n del Sistema</h4>
            <div class="detalles-grid">
              <div class="detalle-item">
                <label><i class="bi bi-circle-fill"></i> Estado</label>
                <span class="badge" [ngClass]="getEstadoBadgeClass(usuarioDetalles.estado)">
                  {{ usuarioDetalles.estado }}
                </span>
              </div>
              <div class="detalle-item">
                <label><i class="bi bi-calendar-check"></i> Fecha de Registro</label>
                <span>{{ usuarioDetalles.fecha_registro | date: 'dd/MM/yyyy HH:mm' }}</span>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button (click)="cerrarModalDetalles()" type="button" class="btn btn-secondary">
            <i class="bi bi-x-circle"></i> Cerrar
          </button>
          <button (click)="abrirModalEditar(usuarioDetalles); cerrarModalDetalles()" type="button" class="btn btn-primary">
            <i class="bi bi-pencil-square"></i> Editar {{ config.nombreSingular }}
          </button>
        </div>
      </div>
    </div>
  }

  <!-- MODAL CREAR/EDITAR -->
  @if (mostrarModal) {
    <div class="modal-overlay" (click)="cerrarModal()">
      <div class="modal modal-form" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>
            <i [class]="modoModal === 'crear' ? 'bi bi-person-plus-fill' : 'bi bi-person-fill-gear'"></i>
            {{ modoModal === 'crear' ? 'Nuevo ' + config.nombreSingular : 'Editar ' + config.nombreSingular }}
          </h2>
          <button (click)="cerrarModal()" class="btn-close">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        <div class="modal-body">
          
          <!-- ‚úÖ FOTO DE PERFIL (solo en edici√≥n) -->
          @if (modoModal === 'editar') {
            <div class="form-section form-section-foto">
              <h4><i class="bi bi-camera-fill"></i> Foto de Perfil</h4>
              <div class="foto-perfil-editor">
                <div class="foto-preview-container">
                  @if (previewFoto || usuarioSeleccionado?.foto_perfil) {
                    <img 
                      [src]="getFotoActual()" 
                      [alt]="formulario.nombres"
                      class="foto-preview-img"
                      onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                    />
                    <div class="foto-placeholder" style="display: none;">
                      <i class="bi bi-person-circle"></i>
                    </div>
                  } @else {
                    <div class="foto-placeholder">
                      <i class="bi bi-person-circle"></i>
                    </div>
                  }
                </div>
                <div class="foto-actions">
                  <button 
                    type="button"
                    class="btn btn-secondary btn-sm" 
                    (click)="abrirSelectorFoto()" 
                    [disabled]="subiendoFoto">
                    <i [class]="subiendoFoto ? 'bi bi-hourglass-split' : 'bi bi-camera-fill'"></i>
                    {{ fotoSeleccionada ? 'Cambiar Imagen' : 'Seleccionar Imagen' }}
                  </button>
                  
                  @if (fotoSeleccionada) {
                    <div class="foto-info">
                      <span class="file-name">{{ fotoSeleccionada.name }}</span>
                      <span class="file-size">({{ (fotoSeleccionada.size / 1024).toFixed(2) }} KB)</span>
                    </div>
                    <div class="foto-buttons">
                      <button 
                        type="button"
                        class="btn btn-sm btn-danger" 
                        (click)="cancelarFoto()" 
                        [disabled]="subiendoFoto">
                        <i class="bi bi-x-circle"></i> Cancelar
                      </button>
                      <button 
                        type="button"
                        class="btn btn-sm btn-primary" 
                        (click)="subirFotoUsuario()" 
                        [disabled]="subiendoFoto">
                        <i [class]="subiendoFoto ? 'bi bi-hourglass-split' : 'bi bi-upload'"></i>
                        {{ subiendoFoto ? 'Subiendo...' : 'Subir' }}
                      </button>
                    </div>
                  }
                  
                  <input 
                    type="file" 
                    id="input-foto-usuario" 
                    accept="image/jpeg,image/jpg,image/png,image/gif"
                    (change)="onFotoSeleccionada($event)"
                    style="display: none;"
                  />
                </div>
              </div>
              <small class="form-hint">
                <i class="bi bi-info-circle"></i> 
                Formatos permitidos: JPG, PNG, GIF. Tama√±o m√°ximo: 5MB
              </small>
            </div>
          }

          <form (ngSubmit)="guardarUsuario()">
            <div class="form-section">
              <h4><i class="bi bi-person-fill"></i> Informaci√≥n Personal</h4>
              <div class="form-row">
                <div class="form-group">
                  <label><i class="bi bi-person"></i> Nombres *</label>
                  <input
                    type="text"
                    [(ngModel)]="formulario.nombres"
                    name="nombres"
                    required
                    placeholder="Ingrese nombres"
                  />
                </div>
                <div class="form-group">
                  <label><i class="bi bi-person"></i> Apellidos *</label>
                  <input
                    type="text"
                    [(ngModel)]="formulario.apellidos"
                    name="apellidos"
                    required
                    placeholder="Ingrese apellidos"
                  />
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label><i class="bi bi-gender-ambiguous"></i> G√©nero</label>
                  <select
                    [(ngModel)]="formulario.genero"
                    name="genero">
                    <option value="">Seleccione g√©nero</option>
                    <option value="Masculino">üë® Masculino</option>
                    <option value="Femenino">üë© Femenino</option>
                    <option value="Otro">üßë Otro</option>
                  </select>
                </div>
                <div class="form-group">
                  <label><i class="bi bi-calendar"></i> Fecha de Nacimiento</label>
                  <input
                    type="date"
                    [(ngModel)]="formulario.fecha_nacimiento"
                    name="fecha_nacimiento"
                  />
                </div>
              </div>
            </div>
            <div class="form-section">
              <h4><i class="bi bi-envelope-fill"></i> Informaci√≥n de Contacto</h4>
              <div class="form-row">
                <div class="form-group">
                  <label><i class="bi bi-envelope"></i> Email *</label>
                  <input
                    type="email"
                    [(ngModel)]="formulario.email"
                    name="email"
                    required
                    placeholder="ejemplo@correo.com"
                  />
                </div>
                <div class="form-group">
                  <label><i class="bi bi-telephone"></i> Tel√©fono</label>
                  <input
                    type="text"
                    [(ngModel)]="formulario.telefono"
                    name="telefono"
                    placeholder="999999999"
                    maxlength="9"
                  />
                </div>
              </div>
              <div class="form-group">
                <label><i class="bi bi-geo-alt"></i> Direcci√≥n</label>
                <input
                  type="text"
                  [(ngModel)]="formulario.direccion"
                  name="direccion"
                  placeholder="Direcci√≥n completa"
                />
              </div>
            </div>
            @if (modoModal === 'crear') {
              <div class="form-section">
                <h4><i class="bi bi-key-fill"></i> Seguridad</h4>
                <div class="form-group">
                  <label><i class="bi bi-key"></i> Contrase√±a *</label>
                  <input
                    type="password"
                    [(ngModel)]="formulario.password"
                    name="password"
                    [required]="modoModal === 'crear'"
                    placeholder="M√≠nimo 6 caracteres"
                    minlength="6"
                  />
                </div>
              </div>
            }
          </form>
        </div>
        <div class="modal-footer">
          <button (click)="cerrarModal()" type="button" class="btn btn-secondary">
            <i class="bi bi-x-circle"></i> Cancelar
          </button>
          <button (click)="guardarUsuario()" type="button" class="btn btn-primary" [disabled]="loading">
            <i [class]="loading ? 'bi bi-hourglass-split' : 'bi bi-check-circle'"></i>
            {{ loading ? 'Guardando...' : 'Guardar' }}
          </button>
        </div>
      </div>
    </div>
  }
</div>
